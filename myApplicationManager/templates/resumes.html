{% load static %}
<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resumes</title>
  <link rel="stylesheet" href="{% static 'homepage.css' %}">
  <style>
    /* Page layout */
    .resumes-container { padding: 24px; }
    .page-title { font-size: 32px; font-weight: 700; margin: 8px 0 16px; }

    .toolbar { display:flex; align-items:center; gap:12px; margin: 8px 0 24px; }
    .search { flex:1; display:flex; align-items:center; gap:8px; }
    .search input {
      width:100%; padding:12px 14px; border:1px solid #d1d5db; border-radius:8px; background:#f3f4f6;
    }

    /* Create card */
    .create-card {
      width: 260px; height: 300px; border:1px dashed #cbd5e1; border-radius:12px;
      display:flex; align-items:center; justify-content:center; flex-direction:column;
      background:#f8fafc; cursor:pointer; margin: 0 auto 24px;
      transition: box-shadow .2s ease, transform .1s ease;
    }
    .create-card:hover { box-shadow:0 4px 14px rgba(0,0,0,.08); transform: translateY(-1px); }
    .create-plus { font-size:48px; margin-bottom:8px; color:#111827; }
    .create-text { font-weight:600; color:#111827; }

    /* List */
    .resume-list { display:flex; flex-direction:column; gap:12px; max-width:760px; margin: 0 auto; }
    .resume-row {
      display:flex; align-items:center; gap:12px; padding:12px; background:#fff; border:1px solid #e5e7eb;
      border-radius:10px; box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .resume-name {
      flex:1; padding:10px 12px; background:#f3f4f6; border-radius:8px; color:#111827;
      border:1px solid #e5e7eb;
    }
    .btn {
      padding:8px 10px; border:1px solid #d1d5db; border-radius:8px; background:#f9fafb; font-size:12px;
      cursor:pointer;
    }
    .btn:hover { background:#f3f4f6; }
    .btn-danger { border-color:#fecaca; background:#fee2e2; }
    .btn-danger:hover { background:#fecaca; }

    /* Modal */
    .modal-backdrop {
      position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; z-index:50;
    }
    .modal {
      position:fixed; inset:0; display:none; place-items:center; z-index:60; padding: 24px;
    }
    .modal.open, .modal-backdrop.open { display:grid; }
    .modal-card {
      width:min(100%, 900px); max-height: 90vh; overflow:auto;
      background:#fff; border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,.2); padding: 20px;
    }
    .modal-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .modal-title { font-size:20px; font-weight:700; }
    .modal-body { display:flex; flex-direction:column; gap:18px; }
    .section { border:1px solid #e5e7eb; border-radius:10px; padding:14px; }
    .section h3 { margin:0 0 8px; font-size:16px; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .grid-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field label { font-size:12px; color:#374151; }
    .field input, .field textarea, .field select {
      padding:10px; border:1px solid #d1d5db; border-radius:8px; background:#fff;
    }
    .row {
      border:1px dashed #e5e7eb; border-radius:10px; padding:12px; margin:10px 0; position:relative;
    }
    .row .remove {
      position:absolute; top:10px; right:10px; font-size:12px; cursor:pointer; border:none; background:#fee2e2; border-radius:6px; padding:4px 8px;
    }
    .add-btn { margin-top:8px; }

    .modal-footer { display:flex; justify-content:flex-end; gap:10px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="resumes-container">
    <a class="btn" href="{% url 'myApplicationManager:homepage' %}">← Back to Dashboard</a>

    <h1 class="page-title">Resumes</h1>

    <div class="toolbar">
      <div class="search">
        <input id="searchInput" type="text" placeholder="Search Resume" />
      </div>
    </div>

    <!-- Create card -->
    <div id="createCard" class="create-card" role="button" tabindex="0" aria-label="Create new resume">
      <div class="create-plus">＋</div>
      <div class="create-text">Create new resume</div>
    </div>

    <!-- List -->
    <div id="resumeList" class="resume-list" aria-live="polite"></div>
  </div>

  <!-- Modal Backdrop -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true"></div>

  <!-- Modal -->
  <div id="resumeModal" class="modal" aria-hidden="true" aria-labelledby="modalTitle" role="dialog">
    <div class="modal-card">
      <div class="modal-header">
        <div id="modalTitle" class="modal-title">Create Resume</div>
        <button class="btn" onclick="closeModal()">✕</button>
      </div>

      <div class="modal-body">
        <!-- Resume meta -->
        <div class="section">
          <h3>Resume Info</h3>
          <div class="field">
            <label for="resumeName">Name</label>
            <input id="resumeName" type="text" placeholder="e.g., Software Engineer Resume" />
          </div>
        </div>

        <!-- Experience -->
        <div class="section">
          <h3>Experience</h3>
          <div id="expContainer"></div>
          <button class="btn add-btn" type="button" onclick="addExperience()">＋ Add experience</button>
        </div>

        <!-- Education -->
        <div class="section">
          <h3>Education</h3>
          <div id="eduContainer"></div>
          <button class="btn add-btn" type="button" onclick="addEducation()">＋ Add education</button>
        </div>

        <!-- Skills -->
        <div class="section">
          <h3>Skills</h3>
          <div id="skillContainer"></div>
          <button class="btn add-btn" type="button" onclick="addSkill()">＋ Add skill</button>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button id="saveBtn" class="btn" onclick="saveResume()">Save</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    function getCookie(name) { // same approach used elsewhere in your app
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function showToast(msg, ok=true) {
      const d = document.createElement('div');
      d.style.cssText = `
        position:fixed; top:20px; right:20px; z-index:1000; color:#fff; font-weight:700;
        border-radius:8px; padding:12px 16px; ${ok ? 'background:#10b981' : 'background:#ef4444'}
      `;
      d.textContent = msg;
      document.body.appendChild(d);
      setTimeout(()=>d.remove(), 2800);
    }

    // ---------- State ----------
    let editingId = null; // resumeID when editing

    // ---------- Modal open/close ----------
    const modal = document.getElementById('resumeModal');
    const backdrop = document.getElementById('modalBackdrop');
    function openModal(mode='create', data=null) {
      document.getElementById('modalTitle').textContent = mode === 'edit' ? 'Edit Resume' : 'Create Resume';
      document.getElementById('resumeName').value = data?.name || '';

      // clear containers
      document.getElementById('expContainer').innerHTML = '';
      document.getElementById('eduContainer').innerHTML = '';
      document.getElementById('skillContainer').innerHTML = '';

      // prefill rows if editing
      (data?.jobs || []).forEach(addExperience);
      (data?.education || []).forEach(addEducation);
      (data?.skills || []).forEach(addSkill);

      editingId = mode === 'edit' ? data.resumeID : null;

      modal.classList.add('open');
      backdrop.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
      backdrop.setAttribute('aria-hidden', 'false');
    }
    function closeModal() {
      modal.classList.remove('open');
      backdrop.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      backdrop.setAttribute('aria-hidden', 'true');
      editingId = null;
    }
    document.getElementById('createCard').addEventListener('click', () => openModal('create'));

    // ---------- Dynamic row builders ----------
    function addExperience(prefill={}) {
      const wrap = document.createElement('div');
      wrap.className = 'row';
      wrap.innerHTML = `
        <button class="remove" type="button">Remove</button>
        <div class="grid-2">
          <div class="field">
            <label>Job Title</label>
            <input type="text" data-key="job_title" value="${prefill.job_title || ''}">
          </div>
          <div class="field">
            <label>Company Name</label>
            <input type="text" data-key="company_name" value="${prefill.company_name || ''}">
          </div>
        </div>
        <div class="grid-2">
          <div class="field">
            <label>Start Date</label>
            <input type="date" data-key="start_date" value="${prefill.start_date || ''}">
          </div>
          <div class="field">
            <label>End Date</label>
            <input type="date" data-key="end_date" value="${prefill.end_date || ''}">
          </div>
        </div>
        <div class="field">
          <label>Description</label>
          <textarea rows="3" data-key="description">${prefill.description || ''}</textarea>
        </div>
        ${prefill.id ? `<input type="hidden" data-key="id" value="${prefill.id}">` : ''}
      `;
      wrap.querySelector('.remove').onclick = () => wrap.remove();
      document.getElementById('expContainer').appendChild(wrap);
    }

    function addEducation(prefill={}) {
      const wrap = document.createElement('div');
      wrap.className = 'row';
      wrap.innerHTML = `
        <button class="remove" type="button">Remove</button>
        <div class="grid-2">
          <div class="field">
            <label>School Name</label>
            <input type="text" data-key="school_name" value="${prefill.school_name || ''}">
          </div>
          <div class="field">
            <label>Degree</label>
            <input type="text" data-key="degree" value="${prefill.degree || ''}">
          </div>
        </div>
        <div class="grid-2">
          <div class="field">
            <label>Start Date</label>
            <input type="date" data-key="start_date" value="${prefill.start_date || ''}">
          </div>
          <div class="field">
            <label>End Date</label>
            <input type="date" data-key="end_date" value="${prefill.end_date || ''}">
          </div>
        </div>
        <div class="field">
          <label>Description</label>
          <textarea rows="3" data-key="description">${prefill.description || ''}</textarea>
        </div>
        ${prefill.id ? `<input type="hidden" data-key="id" value="${prefill.id}">` : ''}
      `;
      wrap.querySelector('.remove').onclick = () => wrap.remove();
      document.getElementById('eduContainer').appendChild(wrap);
    }

    function addSkill(prefill={}) {
      const wrap = document.createElement('div');
      wrap.className = 'row';
      wrap.innerHTML = `
        <button class="remove" type="button">Remove</button>
        <div class="grid-3">
          <div class="field">
            <label>Skill Name</label>
            <input type="text" data-key="skill_name" value="${prefill.skill_name || ''}">
          </div>
          <div class="field">
            <label>Proficiency Level</label>
            <select data-key="proficiency_level">
              <option value="">Select</option>
              <option ${prefill.proficiency_level==='beginner'?'selected':''} value="beginner">Beginner</option>
              <option ${prefill.proficiency_level==='intermediate'?'selected':''} value="intermediate">Intermediate</option>
              <option ${prefill.proficiency_level==='advanced'?'selected':''} value="advanced">Advanced</option>
              <option ${prefill.proficiency_level==='expert'?'selected':''} value="expert">Expert</option>
            </select>
          </div>
          <div></div>
        </div>
        ${prefill.id ? `<input type="hidden" data-key="id" value="${prefill.id}">` : ''}
      `;
      wrap.querySelector('.remove').onclick = () => wrap.remove();
      document.getElementById('skillContainer').appendChild(wrap);
    }

    // ---------- Collect data ----------
    function collectRows(containerId) {
      return Array.from(document.getElementById(containerId).children).map(row => {
        const fields = row.querySelectorAll('[data-key]');
        const obj = {};
        fields.forEach(el => { obj[el.getAttribute('data-key')] = el.value || null; });
        return obj;
      });
    }
    function collectPayload() {
      return {
        name: document.getElementById('resumeName').value.trim(),
        jobs: collectRows('expContainer'),       // Experience
        education: collectRows('eduContainer'),  // Education
        skills: collectRows('skillContainer')    // Skills
      };
    }

    // ---------- Save (POST or PATCH) ----------
    async function saveResume() {
      const payload = collectPayload();
      if (!payload.name) return showToast('Please provide a resume name', false);

      const method = editingId ? 'PATCH' : 'POST';
      const url = editingId ? `/api/resumes/${editingId}/` : '/api/resumes/';

      try {
        const res = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const err = await res.json().catch(()=>({}));
          throw new Error(err?.detail || 'Failed to save resume.');
        }
        showToast('Saved!');
        closeModal();
        loadResumes();
      } catch (e) {
        console.error(e);
        showToast(e.message || 'Error', false);
      }
    }

    // ---------- List / Search ----------
    async function loadResumes() {
      try {
        const res = await fetch('/api/resumes/');
        const data = await res.json();
        renderResumes(data || []);
      } catch (e) {
        console.error(e);
        document.getElementById('resumeList').innerHTML =
          '<div class="resume-row">Error loading resumes.</div>';
      }
    }

    function renderResumes(list) {
      const q = (document.getElementById('searchInput').value || '').toLowerCase();
      const filtered = list.filter(r => (r.name || '').toLowerCase().includes(q));
      const el = document.getElementById('resumeList');
      if (!filtered.length) {
        el.innerHTML = '<div class="resume-row"><div class="resume-name">No resumes yet.</div></div>';
        return;
      }
      el.innerHTML = filtered.map(r => `
        <div class="resume-row">
          <div class="resume-name">${r.name || '(untitled)'}</div>
          <button class="btn" onclick='editResume(${JSON.stringify(r).replace(/'/g,"&#39;")})'>Edit</button>
          <button class="btn" onclick='duplicateResume("${r.resumeID}")'>Duplicate</button>
          <button class="btn" onclick='downloadResume("${r.resumeID}")'>Download</button>
          <button class="btn btn-danger" onclick='deleteResume("${r.resumeID}")'>Delete</button>
        </div>
      `).join('');
    }

    document.getElementById('searchInput').addEventListener('input', loadResumes);

    // ---------- Row actions ----------
    function editResume(resumeObj) { openModal('edit', resumeObj); }

    async function duplicateResume(id) {
      try {
        const res = await fetch(`/api/resumes/${id}/`);
        const data = await res.json();
        const copy = { ...data, name: (data.name || 'Resume') + ' (copy)' };
        delete copy.resumeID;
        const res2 = await fetch('/api/resumes/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
          body: JSON.stringify(copy)
        });
        if (!res2.ok) throw new Error('Failed to duplicate');
        showToast('Duplicated!');
        loadResumes();
      } catch (e) { console.error(e); showToast('Duplicate failed', false); }
    }

    async function downloadResume(id) {
      try {
        const res = await fetch(`/api/resumes/${id}/`);
        const data = await res.json();
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = (data.name || 'resume') + '.json';
        a.click(); URL.revokeObjectURL(url);
      } catch (e) { console.error(e); showToast('Download failed', false); }
    }

    async function deleteResume(id) {
      if (!confirm('Delete this resume?')) return;
      try {
        const res = await fetch(`/api/resumes/${id}/`, {
          method: 'DELETE',
          headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });
        if (!res.ok && res.status !== 204) throw new Error('Delete failed');
        showToast('Deleted');
        loadResumes();
      } catch (e) { console.error(e); showToast('Delete failed', false); }
    }

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', () => {
      loadResumes();
    });
  </script>
</body>
</html>
