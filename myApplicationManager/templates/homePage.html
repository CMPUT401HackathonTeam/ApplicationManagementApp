

{% load static %}
<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Job Dashboard</title>
  <link rel="stylesheet" href="{% static 'homepage.css' %}">
  <style>
    .applications-container { padding: 20px; }
    .application-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      margin: 10px 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .application-info h3 { margin: 0 0 5px 0; color: #1f2937; }
    .application-info p { margin: 0; color: #6b7280; font-size: 14px; }
    .application-info small { color: #9ca3af; font-size: 12px; }
    .status-select {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 14px;
    }
    .status-applied { background-color: #dbeafe; color: #1e40af; }
    .status-interview { background-color: #fef3c7; color: #92400e; }
    .status-accepted { background-color: #d1fae5; color: #065f46; }
    .status-rejected { background-color: #fee2e2; color: #991b1b; }
    .no-applications {
      text-align: center;
      padding: 40px;
      color: #6b7280;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .applications-list { margin-top: 20px; }
    .logout-button {
      text-decoration: none;
      color: #1e40af;
      font-weight: 600;
      padding: 0.5em 1em;
      border-radius: 0.5em;
      background: transparent;
      border: none;
      cursor: pointer;
    }

    /* -------- Jobs Styling -------- */
    .job-card {
      display: flex;
      flex-direction: column;
      padding: 15px;
      margin: 10px 0;
      background: #f9fafb;
      border-radius: 12px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .job-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .job-card h3 {
      margin: 0 0 8px 0;
      color: #1f2937;
      font-size: 18px;
    }

    .job-card p {
      margin: 4px 0;
      color: #4b5563;
      font-size: 14px;
    }

    .job-card button.apply-btn {
      margin-top: 10px;
      padding: 0.5em 1em;
      background: #1e40af;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .job-card button.apply-btn:hover {
      background: #2563eb;
    }

    /* -------- Profile Styling -------- */
    .profile-container-full {
      padding: 20px;
      background: transparent;
      max-width: none;
      width: 100%;
      margin: 0 auto;
    }

    #profile-container ul {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 16px;
      line-height: 1.6;
      color: #1e3a8a;
    }

    #profile-container li { margin-bottom: 10px; }

    #profile-container a {
      display: inline-block;
      margin-top: 15px;
      padding: 0.5em 1em;
      background: #1e40af;
      color: white;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
    }

    #profile-container a:hover { background: #2563eb; }
      
      .resumes-container { padding: 24px; }
    .page-title { font-size: 32px; font-weight: 700; margin: 8px 0 16px; }

    .toolbar { display:flex; align-items:center; gap:12px; margin: 8px 0 24px; }
    .search { flex:1; display:flex; align-items:center; gap:8px; }
    .search input {
      width:100%; padding:12px 14px; border:1px solid #d1d5db; border-radius:8px; background:#f3f4f6;
    }
    .create-card {
      width: 260px; height: 300px; border:1px dashed #cbd5e1; border-radius:12px;
      display:flex; align-items:center; justify-content:center; flex-direction:column;
      background:#f8fafc; cursor:pointer; margin: 0 auto 24px;
      transition: box-shadow .2s ease, transform .1s ease;
    }
    .create-card:hover { box-shadow:0 4px 14px rgba(0,0,0,.08); transform: translateY(-1px); }
    .create-plus { font-size:48px; margin-bottom:8px; color:#111827; }
    .create-text { font-weight:600; color:#111827; }

    /*Resume Modal*/
    /* Modal */
    .modal-backdrop {
      position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; z-index:50;
    }
    .modal {
      position:fixed; inset:0; display:none; place-items:center; z-index:60; padding: 24px;
    }
    .modal.open, .modal-backdrop.open { display:grid; }
    .modal-card {
      width:min(100%, 900px); max-height: 90vh; overflow:auto;
      background:#fff; border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,.2); padding: 20px;
    }
    .modal-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .modal-title { font-size:20px; font-weight:700; }
    .modal-body { display:flex; flex-direction:column; gap:18px; }
    .section { border:1px solid #e5e7eb; border-radius:10px; padding:14px; }
    .section h3 { margin:0 0 8px; font-size:16px; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .grid-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field label { font-size:12px; color:#374151; }
    .field input, .field textarea, .field select {
      padding:10px; border:1px solid #d1d5db; border-radius:8px; background:#fff;
    }
    .row {
      border:1px dashed #e5e7eb; border-radius:10px; padding:12px; margin:10px 0; position:relative;
    }
    .row .remove {
      position:absolute; top:10px; right:10px; font-size:12px; cursor:pointer; border:none; background:#fee2e2; border-radius:6px; padding:4px 8px;
    }
    .add-btn { margin-top:8px; }

    .modal-footer { display:flex; justify-content:flex-end; gap:10px; margin-top:8px; }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand"><span class="dot" aria-hidden="true"></span> Job Portal</div>
    <div class="profile">
      <a href="#profile" data-view="profile" style="text-decoration:none; color:inherit;">
        <div class="avatar" aria-hidden="true">
          <div class="placeholder">P</div>
        </div>
        <div class="meta">
          <div class="name">Profile</div>
        </div>
      </a>
    </div>
    <nav class="nav" aria-label="Primary">
      <a href="#dashboard" class="active" data-view="dashboard"><span class="icon">üè†</span><span>Dashboard</span></a>
      <a href="#inbox" data-view="inbox"><span class="icon">üì•</span><span>Inbox</span></a>
      <a href="#applications" data-view="applications"><span class="icon">üìù</span><span>Applications</span></a>
      <a href="#jobs" data-view="jobs"><span class="icon">üíº</span><span>Jobs</span></a>
      <a href="#resume" data-view="resume"><span class="icon">üìÑ</span><span>Resumes</span></a>
    </nav>
    <div style="margin-top:auto; display:flex; flex-direction:column; gap:0.5em;">
      <form method="post" action="{% url 'myApplicationManager:logout' %}">
        {% csrf_token %}
        <button type="submit" class="logout-button">üîì Logout</button>
      </form>
      <div style="font-size:12px; color:#9ca3af; opacity:.9;">¬© Job Portal 2025</div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="title" id="page-title">Overview</div>
      <div class="filters" id="filters" hidden>
        <select id="filter-scope" aria-label="Scope">
          <option value="all" selected>All</option>
        </select>
        <select id="filter-read" aria-label="Read Status">
          <option value="unread">Unread</option>
          <option value="read">Read</option>
        </select>
        <select id="filter-sort" aria-label="Sort">
          <option value="newest" selected>Newest</option>
          <option value="oldest">Oldest</option>
        </select>
      </div>
    </div>

    <!-- Views -->
    <section id="dashboard-view" class="view">
      <section class="stats-grid" aria-label="Stats">
        <article class="card" tabindex="0">
          <h3>Applications Submitted</h3>
          <div class="kpi" id="kpi-applications-submitted">0</div>
          <div class="muted">30 Days</div>
        </article>
        <article class="card" tabindex="0">
          <h3>Interviews Booked</h3>
          <div class="kpi" id="kpi-interviews-booked">0</div>
        </article>
        <article class="card" tabindex="0">
          <h3>Current Openings</h3>
          <div class="kpi" id="kpi-current-openings">0</div>
          <div class="muted">Based on your preference</div>
        </article>
        <article class="card" tabindex="0">
          <h3>Inbox</h3>
          <div class="kpi" id="kpi-inbox">0</div>
          <div class="muted">0 unread</div>
        </article>
      </section>
    </section>


    <section id="inbox-view" class="view hidden" aria-label="Inbox">
      <ul class="inbox-list"></ul>
    </section>

    <section id="applications-view" class="view hidden">
      <div class="applications-container">
        <h2>My Applications</h2>
        <div id="applications-stats" class="stats-grid"></div>
        <div id="applications-list" class="applications-list"></div>
        <div id="no-applications" >
        </div>
      </div>
    </section>

    <section id="jobs-view" class="view hidden"></section>
    <section id="resume-view" class="view hidden">
        <div class="applications-container">
          <h2>My Resumes</h2>
          <div class="toolbar">
            <div class="search">
              <input id="searchInput" type="text" placeholder="Search Resume" />
            </div>
          </div>
          <!-- Create card -->
          <div id="createCard" class="create-card" role="button" tabindex="0" aria-label="Create new resume">
            <div class="create-plus">Ôºã</div>
            <div class="create-text">Create new resume</div>
          </div>

          <!-- Modal Backdrop -->
          <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true"></div>

          <!-- Modal -->
          <div id="resumeModal" class="modal" aria-hidden="true" aria-labelledby="modalTitle" role="dialog">
            <div class="modal-card">
              <div class="modal-header">
                <div id="modalTitle" class="modal-title">Create Resume</div>
                <button class="btn" onclick="closeModal()">‚úï</button>
            </div>

          <div class="modal-body">
            <!-- Resume meta -->
            <div class="section">
              <h3>Resume Info</h3>
              <div class="field">
            <label for="resumeName">Name</label>
            <input id="resumeName" type="text" placeholder="e.g., Software Engineer Resume" />
          </div>
        </div>

        <!-- Experience -->
        <div class="section">
          <h3>Experience</h3>
          <div id="expContainer"></div>
          <button class="btn add-btn" type="button" onclick="addExperience()">Ôºã Add experience</button>
        </div>

        <!-- Education -->
        <div class="section">
          <h3>Education</h3>
          <div id="eduContainer"></div>
          <button class="btn add-btn" type="button" onclick="addEducation()">Ôºã Add education</button>
        </div>

        <!-- Skills -->
        <div class="section">
          <h3>Skills</h3>
          <div id="skillContainer"></div>
          <button class="btn add-btn" type="button" onclick="addSkill()">Ôºã Add skill</button>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button id="saveBtn" class="btn" onclick="saveResume()">Save</button>
      </div>
    </div>
  </div>

          <div id="resumes-list" class="applications-list"></div>
          <div id="no-resumes" class="no-applications hidden">
            <h3>No Resumes Uploaded</h3>
            <p>You haven't uploaded any resumes yet. Start by adding your resume!</p>
          </div>
        </div>
      </section>

    <section id="profile-view" class="view hidden">
      <div class="profile-container-full">
        <h2>My Profile</h2>
        <div id="profile-container">
          <p>Loading profile...</p>
        </div>
      </div>
    </section>

<script>
(function () {
  const navLinks = document.querySelectorAll('.nav a[data-view], .profile a[data-view]');
  const views = {
    dashboard: document.getElementById('dashboard-view'),
    inbox: document.getElementById('inbox-view'),
    applications: document.getElementById('applications-view'),
    jobs: document.getElementById('jobs-view'),
    resume: document.getElementById('resume-view'),
    profile: document.getElementById('profile-view')
  };
  const pageTitle = document.getElementById('page-title');
  const filters = document.getElementById('filters');

  function setActive(link) {
    navLinks.forEach(a => a.classList.remove('active'));
    if (link) link.classList.add('active');
  }

  function showView(name) {
    Object.entries(views).forEach(([k, el]) => el && el.classList.toggle('hidden', k !== name));
    if (name === 'inbox') {
      pageTitle.textContent = 'Inbox'; filters.hidden = false;
    } else if (name === 'applications') {
      pageTitle.textContent = 'Applications'; filters.hidden = true; loadApplicationsData();
    } else if (name === 'jobs') {
      pageTitle.textContent = 'Jobs'; filters.hidden = true; loadJobsData();
    } else if (name === 'profile') {
      pageTitle.textContent = 'Profile'; filters.hidden = true; loadProfileData();
    } else if (name === 'dashboard') {
      pageTitle.textContent = 'Overview'; filters.hidden = true; updateDashboardKPIs();
    } else {
      pageTitle.textContent = name[0].toUpperCase() + name.slice(1);
      filters.hidden = true;
    }
  }

  navLinks.forEach(a => a.addEventListener('click', e => {
    e.preventDefault();
    const view = a.getAttribute('data-view');
    setActive(a); showView(view); history.pushState(null, '', '#' + view);
  }));

  const initial = (location.hash || '#dashboard').replace('#', '');
  const initialLink = Array.from(navLinks).find(a => a.getAttribute('data-view') === initial);
  setActive(initialLink || document.querySelector('.nav a[data-view="dashboard"]'));
  showView(initial in views ? initial : 'dashboard');

  window.addEventListener('popstate', () => {
    const v = (location.hash || '#dashboard').replace('#', '');
    const link = Array.from(navLinks).find(a => a.getAttribute('data-view') === v);
    setActive(link); showView(v in views ? v : 'dashboard');
  });

  /* -------- Dashboard KPIs -------- */
async function updateDashboardKPIs() {
  try {
    const response = await fetch("{% url 'myApplicationManager:get_applications_data' %}");
    if (!response.ok) throw new Error("Failed to fetch applications");

    const data = await response.json();

    // Applications Submitted = total applications
    const submitted = Array.isArray(data.applications) ? data.applications.length : 0;
    const submittedEl = document.getElementById("kpi-applications-submitted");
    if (submittedEl) submittedEl.textContent = submitted;

    // Interviews Booked = INTERVIEW status count
    const interviews = data.status_counts?.INTERVIEW || 0;
    const interviewsEl = document.getElementById("kpi-interviews-booked");
    if (interviewsEl) interviewsEl.textContent = interviews;

    // Leave Current Openings + Inbox unchanged for now
  } catch (err) {
    console.error("Failed to update dashboard KPIs:", err);
  }
}


  /* -------- Applications -------- */
  function loadApplicationsData() {
    fetch('{% url "myApplicationManager:get_applications_data" %}')
      .then(response => response.json())
      .then(data => displayApplicationsData(data))
      .catch(() => showApplicationsError());
  }

  function displayApplicationsData(data) {
    const statsContainer = document.getElementById('applications-stats');
    const listContainer = document.getElementById('applications-list');
    const noApplications = document.getElementById('no-applications');

    // Update stats
    statsContainer.innerHTML = `
      <article class="card"><h3>Applied</h3><div class="kpi">${data.status_counts?.APPLIED || 0}</div></article>
      <article class="card"><h3>Interview</h3><div class="kpi">${data.status_counts?.INTERVIEW || 0}</div></article>
      <article class="card"><h3>Accepted</h3><div class="kpi">${data.status_counts?.ACCEPTED || 0}</div></article>
      <article class="card"><h3>Rejected</h3><div class="kpi">${data.status_counts?.REJECTED || 0}</div></article>
    `;

    if (Array.isArray(data.applications) && data.applications.length > 0) {
      noApplications.classList.add('hidden');
      listContainer.innerHTML = data.applications.map(app => `
        <div class="application-item">
          <div class="application-info">
            <h3>${app.company_name}</h3>
            <p>${app.position}</p>
            <small>Applied: ${app.applied_date}</small>
          </div>
          <div>
            <select class="status-select status-${app.status.toLowerCase()}"
                    data-application-id="${app.id}"
                    onchange="updateApplicationStatus(this)">
              <option value="APPLIED" ${app.status === 'APPLIED' ? 'selected' : ''}>Applied</option>
              <option value="INTERVIEW" ${app.status === 'INTERVIEW' ? 'selected' : ''}>Interview</option>
              <option value="ACCEPTED" ${app.status === 'ACCEPTED' ? 'selected' : ''}>Accepted</option>
              <option value="REJECTED" ${app.status === 'REJECTED' ? 'selected' : ''}>Rejected</option>
            </select>
          </div>
        </div>
      `).join('');
    } else {
      listContainer.innerHTML = '';
      noApplications.classList.remove('hidden');
    }
  }

  function showApplicationsError() {
    document.getElementById('applications-list').innerHTML =
      '<div class="error">Error loading applications. Please try again.</div>';
  }

  /* -------- Jobs -------- */
  function loadJobsData() {
    fetch('{% url "myApplicationManager:get_jobs_to_apply" %}')
      .then(response => response.json())
      .then(data => displayJobsData(data.jobs))
      .catch(() => {
        document.getElementById('jobs-view').innerHTML =
          '<div class="error">Error loading jobs. Please try again.</div>';
      });
  }

  function displayJobsData(jobs) {
    const container = document.getElementById('jobs-view');
    if (!jobs.length) {
      container.innerHTML = '<p>No new jobs to view.</p>';
      return;
    }

    container.innerHTML = jobs.map(job => `
      <div class="job-card">
        <h3>${job.position} at ${job.companyName}</h3>
        ${job.salary ? `<p><strong>Salary:</strong> ${job.salary}</p>` : ''}
        ${job.jobDetails ? `<p>${job.jobDetails}</p>` : ''}
        <button class="apply-btn" data-job-id="${job.jobID}">Apply</button>
      </div>
    `).join('');

    container.querySelectorAll('.apply-btn').forEach(btn => {
      btn.addEventListener('click', () => applyToJob(btn.dataset.jobId));
    });
  }

  window.applyToJob = function(jobID) {
    fetch(`/apply-to-job/${jobID}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({ jobID })
    })
    .then(response => {
      if (!response.ok) throw new Error('Failed to apply.');
      return response.json();
    })
    .then(() => {
      alert('Application submitted!');
      loadJobsData();
      loadApplicationsData();
      updateDashboardKPIs();
    })
    .catch(err => alert(err.message));
  }

  function getCSRFToken() {
    const name = 'csrftoken';
    const cookies = document.cookie.split(';').map(c => c.trim());
    const cookie = cookies.find(c => c.startsWith(name + '='));
    return cookie ? cookie.split('=')[1] : '';
  }

  /* -------- Profile -------- */
  function loadProfileData() {
    fetch('{% url "myApplicationManager:profile_detail_api" %}')
      .then(response => response.json())
      .then(data => {
        const profile = data.profile;
        document.getElementById('profile-container').innerHTML = `
          <ul>
            <li><strong>Email:</strong> ${profile.email}</li>
            <li><strong>First Name:</strong> ${profile.firstName}</li>
            <li><strong>Last Name:</strong> ${profile.lastName}</li>
            <li><strong>Phone:</strong> ${profile.phoneNumber}</li>
            <li><strong>Street:</strong> ${profile.street}</li>
            <li><strong>City:</strong> ${profile.city}</li>
            <li><strong>Province:</strong> ${profile.province}</li>
            <li><strong>Postal Code:</strong> ${profile.postalCode}</li>
          </ul>
          <a href="{% url 'myApplicationManager:profile_edit' %}">Edit Profile</a>
        `;
      })
      .catch(() => {
        document.getElementById('profile-container').innerHTML =
          '<div class="error">Error loading profile. Please try again.</div>';
      });
  }
})();



    // ---------- Helpers ----------
    function getCookie(name) { // same approach used elsewhere in your app
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function showToast(msg, ok=true) {
      const d = document.createElement('div');
      d.style.cssText = `
        position:fixed; top:20px; right:20px; z-index:1000; color:#fff; font-weight:700;
        border-radius:8px; padding:12px 16px; ${ok ? 'background:#10b981' : 'background:#ef4444'}
      `;
      d.textContent = msg;
      document.body.appendChild(d);
      setTimeout(()=>d.remove(), 2800);
    }

    // ---------- State ----------
    let editingId = null; // resumeID when editing

    // ---------- Modal open/close ----------
    const modal = document.getElementById('resumeModal');
    const backdrop = document.getElementById('modalBackdrop');
    function openModal(mode='create', data=null) {
      document.getElementById('modalTitle').textContent = mode === 'edit' ? 'Edit Resume' : 'Create Resume';
      document.getElementById('resumeName').value = data?.name || '';

      // clear containers
      document.getElementById('expContainer').innerHTML = '';
      document.getElementById('eduContainer').innerHTML = '';
      document.getElementById('skillContainer').innerHTML = '';

      // prefill rows if editing
      (data?.jobs || []).forEach(addExperience);
      (data?.education || []).forEach(addEducation);
      (data?.skills || []).forEach(addSkill);

      editingId = mode === 'edit' ? data.resumeID : null;

      modal.classList.add('open');
      backdrop.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
      backdrop.setAttribute('aria-hidden', 'false');
    }
    function closeModal() {
      modal.classList.remove('open');
      backdrop.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      backdrop.setAttribute('aria-hidden', 'true');
      editingId = null;
    }
    document.getElementById('createCard').addEventListener('click', () => openModal('create'));

    // ---------- Dynamic row builders ----------
    function addExperience(prefill={}) {
      const wrap = document.createElement('div');
      wrap.className = 'row';
      wrap.innerHTML = `
        <button class="remove" type="button">Remove</button>
        <div class="grid-2">
          <div class="field">
            <label>Job Title</label>
            <input type="text" data-key="job_title" value="${prefill.job_title || ''}">
          </div>
          <div class="field">
            <label>Company Name</label>
            <input type="text" data-key="company_name" value="${prefill.company_name || ''}">
          </div>
        </div>
        <div class="grid-2">
          <div class="field">
            <label>Start Date</label>
            <input type="date" data-key="start_date" value="${prefill.start_date || ''}">
          </div>
          <div class="field">
            <label>End Date</label>
            <input type="date" data-key="end_date" value="${prefill.end_date || ''}">
          </div>
        </div>
        <div class="field">
          <label>Description</label>
          <textarea rows="3" data-key="description">${prefill.description || ''}</textarea>
        </div>
        ${prefill.id ? `<input type="hidden" data-key="id" value="${prefill.id}">` : ''}
      `;
      wrap.querySelector('.remove').onclick = () => wrap.remove();
      document.getElementById('expContainer').appendChild(wrap);
    }

    function addEducation(prefill={}) {
      const wrap = document.createElement('div');
      wrap.className = 'row';
      wrap.innerHTML = `
        <button class="remove" type="button">Remove</button>
        <div class="grid-2">
          <div class="field">
            <label>School Name</label>
            <input type="text" data-key="school_name" value="${prefill.school_name || ''}">
          </div>
          <div class="field">
            <label>Degree</label>
            <input type="text" data-key="degree" value="${prefill.degree || ''}">
          </div>
        </div>
        <div class="grid-2">
          <div class="field">
            <label>Start Date</label>
            <input type="date" data-key="start_date" value="${prefill.start_date || ''}">
          </div>
          <div class="field">
            <label>End Date</label>
            <input type="date" data-key="end_date" value="${prefill.end_date || ''}">
          </div>
        </div>
        <div class="field">
          <label>Description</label>
          <textarea rows="3" data-key="description">${prefill.description || ''}</textarea>
        </div>
        ${prefill.id ? `<input type="hidden" data-key="id" value="${prefill.id}">` : ''}
      `;
      wrap.querySelector('.remove').onclick = () => wrap.remove();
      document.getElementById('eduContainer').appendChild(wrap);
    }

    function addSkill(prefill={}) {
      const wrap = document.createElement('div');
      wrap.className = 'row';
      wrap.innerHTML = `
        <button class="remove" type="button">Remove</button>
        <div class="grid-3">
          <div class="field">
            <label>Skill Name</label>
            <input type="text" data-key="skill_name" value="${prefill.skill_name || ''}">
          </div>
          <div class="field">
            <label>Proficiency Level</label>
            <select data-key="proficiency_level">
              <option value="">Select</option>
              <option ${prefill.proficiency_level==='beginner'?'selected':''} value="beginner">Beginner</option>
              <option ${prefill.proficiency_level==='intermediate'?'selected':''} value="intermediate">Intermediate</option>
              <option ${prefill.proficiency_level==='advanced'?'selected':''} value="advanced">Advanced</option>
              <option ${prefill.proficiency_level==='expert'?'selected':''} value="expert">Expert</option>
            </select>
          </div>
          <div></div>
        </div>
        ${prefill.id ? `<input type="hidden" data-key="id" value="${prefill.id}">` : ''}
      `;
      wrap.querySelector('.remove').onclick = () => wrap.remove();
      document.getElementById('skillContainer').appendChild(wrap);
    }

    // ---------- Collect data ----------
    function collectRows(containerId) {
      return Array.from(document.getElementById(containerId).children).map(row => {
        const fields = row.querySelectorAll('[data-key]');
        const obj = {};
        fields.forEach(el => { obj[el.getAttribute('data-key')] = el.value || null; });
        return obj;
      });
    }
    function collectPayload() {
      return {
        name: document.getElementById('resumeName').value.trim(),
        jobs: collectRows('expContainer'),       // Experience
        education: collectRows('eduContainer'),  // Education
        skills: collectRows('skillContainer')    // Skills
      };
    }

    // ---------- Save (POST or PATCH) ----------
    async function saveResume() {
      const payload = collectPayload();
      if (!payload.name) return showToast('Please provide a resume name', false);

      const method = editingId ? 'PATCH' : 'POST';
      const url = editingId ? `/api/resumes/${editingId}/` : '/api/resumes/';

      try {
        const res = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const err = await res.json().catch(()=>({}));
          throw new Error(err?.detail || 'Failed to save resume.');
        }
        showToast('Saved!');
        closeModal();
        loadResumes();
      } catch (e) {
        console.error(e);
        showToast(e.message || 'Error', false);
      }
    }

    // ---------- List / Search ----------
    async function loadResumes() {
      try {
        const res = await fetch('/api/resumes/');
        const data = await res.json();
        renderResumes(data || []);
      } catch (e) {
        console.error(e);
        document.getElementById('resumeList').innerHTML =
          '<div class="resume-row">Error loading resumes.</div>';
      }
    }

    function renderResumes(list) {
      const q = (document.getElementById('searchInput').value || '').toLowerCase();
      const filtered = list.filter(r => (r.name || '').toLowerCase().includes(q));
      const el = document.getElementById('resumeList');
      if (!filtered.length) {
        el.innerHTML = '<div class="resume-row"><div class="resume-name">No resumes yet.</div></div>';
        return;
      }
      el.innerHTML = filtered.map(r => `
        <div class="resume-row">
          <div class="resume-name">${r.name || '(untitled)'}</div>
          <button class="btn" onclick='editResume(${JSON.stringify(r).replace(/'/g,"&#39;")})'>Edit</button>
          <button class="btn" onclick='duplicateResume("${r.resumeID}")'>Duplicate</button>
          <button class="btn" onclick='downloadResume("${r.resumeID}")'>Download</button>
          <button class="btn btn-danger" onclick='deleteResume("${r.resumeID}")'>Delete</button>
        </div>
      `).join('');
    }

    document.getElementById('searchInput').addEventListener('input', loadResumes);

    // ---------- Row actions ----------
    function editResume(resumeObj) { openModal('edit', resumeObj); }

    async function duplicateResume(id) {
      try {
        const res = await fetch(`/api/resumes/${id}/`);
        const data = await res.json();
        const copy = { ...data, name: (data.name || 'Resume') + ' (copy)' };
        delete copy.resumeID;
        const res2 = await fetch('/api/resumes/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
          body: JSON.stringify(copy)
        });
        if (!res2.ok) throw new Error('Failed to duplicate');
        showToast('Duplicated!');
        loadResumes();
      } catch (e) { console.error(e); showToast('Duplicate failed', false); }
    }

    async function downloadResume(id) {
      try {
        const res = await fetch(`/api/resumes/${id}/`);
        const data = await res.json();
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = (data.name || 'resume') + '.json';
        a.click(); URL.revokeObjectURL(url);
      } catch (e) { console.error(e); showToast('Download failed', false); }
    }

    async function deleteResume(id) {
      if (!confirm('Delete this resume?')) return;
      try {
        const res = await fetch(`/api/resumes/${id}/`, {
          method: 'DELETE',
          headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });
        if (!res.ok && res.status !== 204) throw new Error('Delete failed');
        showToast('Deleted');
        loadResumes();
      } catch (e) { console.error(e); showToast('Delete failed', false); }
    }

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', () => {
      loadResumes();
    });
</script>

</body>
</html>
